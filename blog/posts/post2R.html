<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Blog - Rushabh Mehta</title>
	<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro&display=swap" rel="stylesheet"> <!-- https://fonts.google.com/ -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/templatemo-xtra-blog.css" rel="stylesheet">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/mystyle.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="/public/css/theorem.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/public/css/w3.css">
  <link rel="stylesheet" href="/public/css/color.css">
<!--
    
TemplateMo 553 Xtra Blog
https://templatemo.com/tm-553-xtra-blog
-->
    <script src="/blog/js/jquery.min.js"></script>
    <script src="/blog/js/templatemo-script.js"></script>
    <script src="/blog/js/jquery_ui.js"></script>
    <script type="text/javascript" async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <script type="text/x-mathjax-config;executed=true">
  MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true,
    }
  });
  </script>

<script>
    function startup() {
	var post_id = 2;
        var client = new XMLHttpRequest();
        client.open('GET', '/blog/reviews/blogdata.txt');
        client.onload = function()
        {
            if(client.responseText != '')
            {
                var txt = client.responseText.split('\n');
		var num = txt.length-1;
		var im = "image";
		var tit = "title";
		var fig = "#fig";
		var rel = "related";
		var data = txt[num-post_id].split('|');
		document.getElementById("title").innerHTML = data[2];
		document.getElementById("tags").innerHTML = data[4];
		document.getElementById("date").innerHTML = data[5];
		if (num < 5) {
		    var i = 1;
		    $("#fig1").hide();
		    $("#fig2").hide();
		    $("#fig3").hide();
		    for (let j = 0; j < num; j++) {
		        if (num-post_id != j) {
			    data = txt[j].split('|');
			    document.getElementById(rel.concat(i.toString())).setAttribute('href',data[0]);
			    document.getElementById(im.concat(i.toString())).setAttribute('src',data[1]);
			    document.getElementById(tit.concat(i.toString())).innerHTML = data[2];
			    $(fig.concat(i.toString())).show();
			    i++;
			}
		    }
		} else {
		    var bucket = [];
		    for (var i=0;i<num;i++) {
			if (i != num - post_id) {
    			bucket.push(i);}
		    }
		    for (var j=1;j<4;j++) {
			data = txt[bucket.splice(Math.floor(Math.random()*bucket.length), 1)[0]].split('|');
			document.getElementById(rel.concat(j.toString())).setAttribute('href',data[0]);
			document.getElementById(im.concat(j.toString())).setAttribute('src',data[1]);
			document.getElementById(tit.concat(j.toString())).innerHTML = data[2];
		    }
		}
            }
        }
	client.send();
    }
    window.addEventListener('load',startup);
</script>
</head>
<body class="theme-base-0h">    <div class="sidebar w3-hide-small" id="mySidebar">
  <div class="container">
    <button class="w3-button sidebar w3-text-white w3-hide-medium w3-hide-large w3-right" onclick="sidebar_close()">☰</button>
    <div class="sidebar-about">
      <div class="w3-text-white w3-center" style="font-size:20px;">
        Rushabh Mehta
      </div>
      
      <p class="lead" style="font-size:16px;font-style:italic;color:rgba(255,255,255,0.5)">For every 0x5f375a86 we learn about, there are thousands we never see<br> - Randall Munroe (XKCD)</p>
      
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">About Me</a>
      <a class="sidebar-nav-item" href="/research/">Research</a>
      <!--<a class="sidebar-nav-item" href="/book/">Book</a>-->
      <a class="sidebar-nav-item active" href="/blog/">Blog</a>
      <!--<a class="sidebar-nav-item" href="/coffee/">Coffee</a>-->
      <a class="sidebar-nav-item" href="/notes/">Notes</a>
      <a class="sidebar-nav-item" href="/resources/">Resources</a>
	    <a class="sidebar-nav-item" href="/contact/">Contact</a>
      <!--<a class="sidebar-nav-item" href="/conjecture/">Conjectures</a>-->
    </nav>
  </div>

    <div class="w3-bottom">
    <p style="font-size:12px;color:rgba(255,255,255,0.5);">© <script>document.write(new Date().getFullYear())</script> Rushabh Mehta</p>
  </div>
</div>

<div class="sidebar w3-hide-medium w3-hide-large w3-right" id="mySmallSidebar">
  <button class="w3-button sidebar w3-text-white" onclick="sidebar_open()">☰</button>
</div>

    <div class="container-fluid">
        <main class="tm-main">     
            <div class="row tm-row">
                <div class="col-12">
                    <hr class="tm-hr-primary tm-mb-55">
			
			
                    <!-- Video player 1422x800 -->
                  <img src="/public/maxresdefault.jpg" style='width:100%;height:auto;' style="border: 1px solid #10cccc" frameborder=0></img>
                </div>
            </div>
            <div class="row tm-row">
                <div class="col-lg-8 tm-post-col">
                    <div class="tm-post-full">                    
                        <div class="mb-4" style='color:black;'>
                            <h2 class="pt-2 tm-color-primary tm-post-title" id='title'>TITLE TO BE FILLED</h2>
                            <p class="tm-mb-40" id='date'>DATE TO BE FILLED</p>
				
				<p>A few days ago, I was reading <a href='https://fossbytes.com/github-copilot-generating-functional-api-keys/' target='_blank' style='color:#0a37cc'>this article</a>, which mentioned an infamous inverse square root algorithm from the video game <i>Quake III</i>. Now, I'm not very knowledgeable on video games, but besides the obvious application of the <a href='https://en.wikipedia.org/wiki/Newton%27s_method' target='_blank' style='color:#0a37cc'>Newton-Raphson method</a>, I couldn't figure out what exactly the code was doing, and so I had to dig deeper. This post is based on the math of <a href='http://www.lomont.org/papers/2003/InvSqrt.pdf' target='_blank' style='color:#0a37cc'>this paper</a>.</p>
				<p>So what exactly is this code? Based on the name of the function, you might guess that it has something to do with square roots. In fact, it's a fast algorithm for approximating the inverse of a square root of a number. Why exactly would anyone care about this?</p>
				<h2>History and Motivation</h2>
				<p>The applications of an inverse square root function were everywhere for physics engines (which <i>Quake III</i> employed heavily). As a simple example, to model object collision, developers need to be able to find the angle between vectors. The typical way to find the angle between non-zero vectors is to use the dot-product: \(v\cdot w=|v||w|\cos\theta\). We can rewrite this as follows:$$\cos\theta=\frac{v\cdot w}{|v||w|}=v\cdot w\times\frac1{\sqrt{v\cdot v}}\times\frac1{\sqrt{w\cdot w}}$$With engines handling thousands of collisions a second, it's not hard to see why an efficient algorithm would be desirable.</p>
				<p>The more interesting story is about its history. Who made this algorithm? How did they come up with it?</p>
				<p>In 2004, Rys Sommerfeldt, Senior Manager of the European Game Engineering Team at AMD RTG, lead an investigation into the history of the algorithm. Initially, he contacted John Carmark, lead developer of <i>Quake III</i>, who suggested that it might be the brain child of Terje Mathisen, an x86 programmer who helped optimize the game.</p>
				<p>Sommerfeldt reached out to Mathisen, who had written an inverse square root function some \(5+\) years earlier, but not the one in the game files. After Sommerfeldt published his findings, the original author, Greg Walsh (founder of Ardent computer), messaged Sommerfeldt that he had developed it while working with Cleve Moler (author of Matlab) and that he was the inspiration for the code.</p>
				<h2><a href='https://en.wikipedia.org/wiki/IEEE_754' target='_blank'>IEEE 754</a></h2>
				<p>Before diving into how the code works, let's understand how C encodes floating point numbers. In most platforms, floating point numbers are assigned \(32\) bits. The first bit is known as the sign bit, representing the sign of the number. So how would you allocate the remaining \(31\) bits to represent floating point (i.e., decimal) numbers?</p>
				<p>The most obvious idea is placing a decimal point right in the middle. We let the first \(16\) digits represent the integral part of the decimal, ranging from \(0\) to \(2^{16}-1\), and the next \(15\) represent the decimal component (sometimes called the <strong>mantissa</strong>). In other terms, we are taking the integer represented by the \(32\) bits, and dividing it by \(2^{15}\). This method of representaion is called the <a href='https://en.wikipedia.org/wiki/Fixed-point_arithmetic' target='_blank' style='color:#0a37cc'>fixed point encoding</a>.</p>
				<p>Does this work? Yes! But it has some issues. First, it has a pretty limited range of numbers it can express (it is bounded from above by \(65536\) and likewise from below. Second, it's a bit wasteful. Suppose we have the number \(62000.0002\). Do we really care about the \(0.002\)? Probably not.</p>
				<p>The key realization is that we only really care about a certain amount of significant figures, regardless of how big or how small the number is. So we look to scientific notation instead.</p>
				<p>For those unfamiliar, scientific notation expresses positive decimals as products of a number in \([1,10)\) with a power of \(10\), i.e., \(403=4.03\times10^2\). In binary, scientific notation expresses positive decimals as products of a number in \([1,2)\) with a power of \(2\).</p>
				<p>But, every number in \([1,2)\) is of the form \(1.\text{mantissa}\), and so the \(1\) is redundant. This brings us to the <a href='https://en.wikipedia.org/wiki/IEEE_754' target='_blank' style='color:#0a37cc'>IEEE 754 standard</a> scheme for encoding floating point numbers.</p>
				<p><a class="gallery img-center-short cboxElement" href="/public/Single-Precision-IEEE-754-Floating-Point-Standard.jpg"><img src="/public/Single-Precision-IEEE-754-Floating-Point-Standard.jpg" width="100%"></a></p>
				<p>The first bit represents the sign, the next eight represent the exponent of \(2\), and the final \(23\) express the mantissa of the number multiplied to the power of \(2\). For the exponent, we might think it should range from \(0\) to \(255\), but we want to encode numbers between \(0\) and \(1\). One idea might be to subtract \(1\) from all positive numbers and \(-1\) from all negative numbers, but this complicates the arithmetic, and thus isn't very good. So, we subtract \(127\) from the exponent, so that it ranges from \(-127\) to \(128\). (As a side note, you might be wondering how we encode \(0\). Simply put, we let \(1\times2^{-127}=0\). What about \(1.5\times2^{-127}\) then? That is an example of a subnormal number, which we won't deal with today. You can read more about the IEEE standard in the link provided.)</p>
				<p>Thus, if \(x\), a positive decimal number, is encoded as \(y\) as a \(32\) bit floating point number, and \(E_y\) represents the eight bit exponent of \(2\) and \(M_y\) the \(23\) bit mantissa, then we have the following relations:$$y=2^{23}E_y+M_y$$$$x=\left(1+\frac{M_y}{2^{23}}\right)\cdot2^{E_y-127}$$</p>
				<h2>A mathematical clue</h2>
				<p>Let's take the second equation and \(\log_2\) both sides:$$\log_2x=\log_2\left(1+\frac{M_y}{2^{23}}\right)+E_y-127$$Observe that for \(z\in[0,1]\), \(z\) is a decent approximation for \(\log_2(1+z)\). With this insight and the observation that \(0\leq M_y\cdot2^{-23}<1\), we have$$\log_2x\sim\frac{M_y}{2^{23}}+E-127=2^{-23}(2^{23}E+M)-127=2^{-23}y-127$$</p>
				<p>This implies that if \(z\) is the floating point representation of \(x^{-0.5}\), the inverse square root of \(x\), then$$2^{-23}z-127\sim\log_2x^{-0.5}=-0.5\log_2x\sim2^{-23}\left(-\frac y2\right)-\frac{127}2$$$$z\sim2^22\cdot127-\frac y2$$Does this formula look similar to the code at all?</p>
				<h2>Bit Manipulation</h2>
				<p>Let's first try to understand the line <code>i = * (long *) &y;</code>. For C programmers, what this line does is quite obvious, but for those who don't program in C, we can break it down as follows:</p>
				<ul style='color:darkgray;'>
					<li><code>&y</code>: & returns the memory address of a variable. This gives us a pointer to the location of the contents of <code>y</code>.</li>
					<li><code>(long *) &y</code>: The type of <code>&y</code> is <code>(float *)</code>, or in English, a pointer to a floating point variable. <code>(long *)</code> tells C that the contents of <code>y</code> are not a float, but a long integer (an integer with \(32\) bits).</li>
					<li><code>i = * (long *) &y</code>: * is the inverse of &, as it takes a pointer, and outputs its content. In this case, the content of the long pointer <code>(long *) &y</code> is just <code>y</code>, but treated as a long integer.</li>
				</ul>
				<p>In summary, all this line of code does is tells C to treat <code>i</code> as a long integer with the same content as <code>y</code>. Likewise, the line <code>y = * (float *) &i;</code> tells C to let <code>y</code> equal <code>i</code>, but treated as a floating point number.</p>
				<p>You may be wondering, why play these games? Why not just work with <code>y</code> as a floating point number?</p>
				<p>C has a lot of bit manipulation operators, like | (or) and ^ (xor), which allow you to work on individual bits of memory. The issue is, given that floating point numbers have assigned specific meaning to individual bits, C has decided to turn off this sort of bit manipulation for floating point numbers.</p>
				<p>So, to get around this, Walsh decided to treat the contents of the float as an integer, engage in <i>evil bit manipulation</i>, and then return it to a floating point variable.</p>
				<p>What bit manipulation did Walsh want to do which was so important that it required these two lines?</p>
				<h2>Bit shift</h2>
				<p>In general, division of numbers is a difficult task for computers, as compared to multiplication and addition. But there is one exception: division by a power of \(2\). Since numbers are stored in base \(2\), dividing by two is as simple as dropping the last bit of an integer (known as a right shift). Multiplication by \(2\) is a left shift.</p>
				<p>C designates these operators as <code>>></code> and <code><<</code>. Remember that we found that \(z\sim2^{22}\cdot127-\frac y2\)? Well, we can write that as \(z\sim\text{ Constant }-(y>>1)\), since shifting right by \(1\) is equivalent to dividing by \(2\). That almost explains the line of code we see in the function...</p>
				<h2>The magic number</h2>
				<p>Based on our formula from above, you'd think, "Ah, the constant 0x5f3759df is just hexadecimal for \(2^{22}\cdot127\)". You'd be close, but not correct. Remember that \(z\sim2^{22}\cdot127-\frac y2\), but doesn't equal it.</p>
				<p>A second guess for what the number might be is the constant \(C\) that minimizes the average value of \(|z_y-(C-0.5y)|\), where for every floating point \(y\), \(z_y\) is the floating point representation of the inverse square root. That, too, would be a great guess. But, the value that minimizes the average value of that expression is 0x5f37642f, which is close, but not exactly the constant.</p>
				<p>The issue with this choice is that while it does minimize the average value of the formula, after applying the Newton-Raphson method (the last line of the code, which we'll discuss in a moment), it actually does worse than 0x5f3759df.</p>
				<p>A third guess might be the constant which minimizes the average absolute difference of the Newton-Raphson method applied to \(C-0.5y\) and \(z_y\). This constant, 0x5f375a86, actually does better on average than 0x5f3759df, but barely. The author of the paper I'm reviewing, Chris Lomont, notes that he'd like to hear from Walsh about how he came up with this constant since there doesn't seem to be any rhyme or reason for it.</p>
				<p>Walsh's response? "Honestly, I don't remember". I guess we'll never know!</p>
				<h2>Newton-Raphson Method</h2>
                            	<p>This is perhaps the most important line of the program, since it takes a decent approximation, and makes it into a great one. I won't explain the whole method here (<a href='https://yihui.org/animation/example/newton-method/' target='_blank' style='color:#0a37cc'>this blog</a> does a fantastic job explaining it</a>), but the idea is that for a convex function, like \(y=x^{-0.5}\), the starting input for the method doesn't really matter, as long as you conduct the method enough times.</p>
				<p>As an example of this, to find the inverse square root of \(2\), we can start at \(1\), and iterate the method enough times to get close to the actual inverse square root, as in the following demonstration.</p>
				<iframe src="https://instacalc.com/50175/embed" width="450" height="350" frameborder="0"></iframe>
				<p>So why bother with the rest of the code? Why not just iterate the method enough times until you get a good result?</p>
				<p>The answer is simple: speed. The Newton-Raphson method isn't particularly slow, but when iterated many times per calculation, the costs add up, especially when this function is called millions of times. What's great about this algorithm is that the initial approximation from our evil bit hack is so close to the actual answer that one iteration of the Newton-Raphson method is sufficient to get an accurate approximation.</p>
				<h2>Conclusion</h2>
				<p>This algorithm might seem like black magic, but it really is a case of a good approximation, coming from the observation that the floating point representation of a number roughly behaves like the log of the number, and through a single iteration of Newton-Raphson.</p>
				<p>Ironically, since the widespread publication of this algorithm, it has become outdated, since it isn't as fast as modern day algorithms. For starters, the casting calls from float to long to float cause a <a href='https://en.wikipedia.org/wiki/Load-Hit-Store' target='_blank' style='color:#0a37cc'>load-hit-store</a>, which slows down the algorithm. Modern day square root implementations are fast enough to outperform this function. Regardless, it's a cool bit of algorithm history, and shows that understanding bit arithmetic isn't just useful for low-level programmers!</p>
				
                            <span class="d-block text-right tm-color-primary" id='tags'>TAGS TO BE PLACED HERE</span>
                        </div> 
		    <script src="https://utteranc.es/client.js"
        repo="rmehtany/comments"
        issue-term="post2R"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
                    </div>
                </div>
                <aside class="col-lg-4 tm-aside-col">
                    <div class="tm-post-sidebar">
                        <hr class="mb-3 tm-hr-primary">
                        <h2 class="mb-4 tm-post-title tm-color-primary">Categories</h2>
                        <ul class="tm-mb-75 pl-5 tm-category-list">
                            <li><a href="/blog/food/" class="tm-color-primary">Food</a></li>
                            <li><a href="/blog/puzzles/" class="tm-color-primary">Puzzles</a></li>
                            <li><a href="/blog/travel/" class="tm-color-primary">Travel</a></li>
                            <li><a href="/blog/sports/" class="tm-color-primary">Sports</a></li>
                            <li><a href="/blog/reviews/" class="tm-color-primary">Reviews</a></li>
                            <li><a href="/blog/other/" class="tm-color-primary">Other</a></li>
                        </ul>
                        <hr class="mb-3 tm-hr-primary">
                        <h2 class="tm-mb-40 tm-post-title tm-color-primary">Related Posts</h2>
                        <a href="#" class="d-block tm-mb-40" id='related1'>
                            <figure id='fig1'>
                                <img src="/blog/img/img-02.jpg" alt="Image" class="mb-3 img-fluid" id='image1'>
                                <figcaption class="tm-color-primary" id='title1'>Duis mollis diam nec ex viverra scelerisque a sit</figcaption>
                            </figure>
                        </a>
                        <a href="#" class="d-block tm-mb-40" id='related2'>
                            <figure id='fig2'>
                                <img src="/blog/img/img-05.jpg" alt="Image" class="mb-3 img-fluid" id='image2'>
                                <figcaption class="tm-color-primary" id='title2'>Integer quis lectus eget justo ullamcorper ullamcorper</figcaption>
                            </figure>
                        </a>
                        <a href="#" class="d-block tm-mb-40" id='related3'>
                            <figure id='fig3'>
                                <img src="/blog/img/img-06.jpg" alt="Image" class="mb-3 img-fluid" id='image3'>
                                <figcaption class="tm-color-primary" id='title3'>Nam lobortis nunc sed faucibus commodo</figcaption>
                            </figure>
                        </a>
                    </div>                    
                </aside>
            </div>
        </main>
    </div>
    <script src="/blog/js/jquery.min.js"></script>
    <script src="/blog/js/templatemo-script.js"></script>
<script>
// sidebar collapse
function sidebar_open() {
  document.getElementById("mySidebar").classList.remove("w3-hide-small");
  document.getElementById("mySmallSidebar").classList.add("w3-hide-small");
}
function sidebar_close() {
  document.getElementById("mySidebar").classList.add("w3-hide-small");
  document.getElementById("mySmallSidebar").classList.remove("w3-hide-small");
}
</script>

</body>
</html>
